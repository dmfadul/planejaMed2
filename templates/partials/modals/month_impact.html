<div class="modal fade" id="monthImpactModal" tabindex="-1" aria-labelledby="monthImpactLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content text-dark bg-white">
      <form id="monthImpactForm" method="POST">
        {% csrf_token %}
        <input type="hidden" name="year" id="monthImpactYear">
        <input type="hidden" name="month" id="monthImpactMonth">
        <input type="hidden" name="mode" id="monthImpactMode">  <!-- create | unlock, if useful server-side -->

        <div class="modal-header">
          <h5 class="modal-title" id="monthImpactLabel">Confirmar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <!-- Status / errors -->
          <div id="impactAlert" class="alert d-none" role="alert"></div>

          <!-- Loading -->
          <div id="impactLoading" class="d-flex align-items-center gap-2">
            <div class="spinner-border" role="status" aria-hidden="true"></div>
            <span>Carregando impacto…</span>
          </div>

          <!-- Results -->
          <div id="impactContent" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <small class="text-muted">Mês alvo</small><br>
                <strong id="impactTarget"></strong>
              </div>
              <div id="noRiskBox" class="alert alert-success py-1 px-2 m-0 d-none">
                Nenhum usuário em risco.
              </div>
            </div>

            <div id="riskBox" class="d-none">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="m-0">Usuários possivelmente afetados</h6>
                <div class="form-check m-0">
                  <input class="form-check-input" type="checkbox" id="toggleSelectAll">
                  <label class="form-check-label" for="toggleSelectAll">Selecionar todos</label>
                </div>
              </div>

              <div id="riskList" class="list-group mb-1"></div>
              <small class="text-muted" id="overrideCountText">0 selecionado(s) para manter.</small>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button id="monthImpactSubmit" type="submit" class="btn btn-primary" disabled>
            Confirmar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
(function () {
  const modalEl = document.getElementById('monthImpactModal');
  const formEl = document.getElementById('monthImpactForm');
  const yearInput = document.getElementById('monthImpactYear');
  const monthInput = document.getElementById('monthImpactMonth');
  const modeInput = document.getElementById('monthImpactMode');

  const impactLoading = document.getElementById('impactLoading');
  const impactContent = document.getElementById('impactContent');
  const impactAlert = document.getElementById('impactAlert');
  const noRiskBox = document.getElementById('noRiskBox');
  const riskBox = document.getElementById('riskBox');
  const impactTarget = document.getElementById('impactTarget');
  const riskList = document.getElementById('riskList');
  const toggleSelectAll = document.getElementById('toggleSelectAll');
  const overrideCountText = document.getElementById('overrideCountText');
  const submitBtn = document.getElementById('monthImpactSubmit');
  const titleEl = document.getElementById('monthImpactLabel');

  let currentImpactUrl = '/api/months/impact';

  function setStateLoading() {
    impactAlert.classList.add('d-none');
    impactContent.classList.add('d-none');
    noRiskBox.classList.add('d-none');
    riskBox.classList.add('d-none');
    submitBtn.disabled = true;
    impactLoading.classList.remove('d-none');
    riskList.innerHTML = '';
    overrideCountText.textContent = '0 selecionado(s) para manter.';
    toggleSelectAll.checked = false;
  }

  function setStateError(msg) {
    impactLoading.classList.add('d-none');
    impactContent.classList.remove('d-none');
    impactAlert.className = 'alert alert-danger';
    impactAlert.textContent = msg || 'Falha ao carregar o impacto.';
    impactAlert.classList.remove('d-none');
    submitBtn.disabled = true;
  }

  function normalizeItem(base, year, month) {
    return {
      user_id: base.user_id,
      user_name: base.user_name ?? '—',
      reason: base.reason ?? '',
      current_entitlement_months: base.current_entitlement_months ?? null,
      can_keep: (typeof base.can_keep === 'boolean') ? base.can_keep : true,
      keep_key: base.keep_key ?? `${base.user_id}-${year}-${String(month).padStart(2, '0')}`,
      will_expire_days: base.will_expire_days ?? null,
    };
  }

  function setStateSuccess(payload) {
    impactLoading.classList.add('d-none');
    impactContent.classList.remove('d-none');
    impactAlert.classList.add('d-none');

    const { year, month, has_risk } = payload;
    const items = Array.isArray(payload.items) ? payload.items : [];

    impactTarget.textContent = `${String(month).padStart(2, '0')}/${year}`;

    if (!has_risk || items.length === 0) {
      noRiskBox.classList.remove('d-none');
      riskBox.classList.add('d-none');
      submitBtn.disabled = false;
      return;
    }

    riskBox.classList.remove('d-none');
    const rows = items.map(raw => {
      const item = normalizeItem(raw, year, month);

      const disabledAttr = item.can_keep ? '' : 'disabled';
      const titleAttr = item.can_keep ? '' : 'title="Não pode ser mantido manualmente"';
      const monthsBadge = (item.current_entitlement_months ?? '') !== ''
        ? `<span class="badge text-bg-light ms-1">${item.current_entitlement_months} meses</span>`
        : '';

      const reasonLine = item.reason
        ? `<div class="small text-muted mt-1">${escapeHtml(item.reason)}</div>`
        : '';

      return `
        <label class="list-group-item d-flex align-items-start gap-2">
          <input
            type="checkbox"
            class="form-check-input mt-1 keep-checkbox"
            data-user-id="${item.user_id}"
            data-keep-key="${escapeHtml(item.keep_key)}"
            ${disabledAttr} ${titleAttr}
          >
          <div class="flex-grow-1">
            <div class="d-flex align-items-center">
              <strong>${escapeHtml(item.user_name)}</strong>
              ${monthsBadge}
            </div>
            ${reasonLine}
          </div>
        </label>
      `;
    }).join('');

    riskList.innerHTML = rows;
    submitBtn.disabled = false;
    updateOverrideCount();
  }

  function updateOverrideCount() {
    const checks = riskList.querySelectorAll('.keep-checkbox:checked');
    overrideCountText.textContent = `${checks.length} selecionado(s) para manter.`;
  }

  function escapeHtml(s) {
    return (s ?? '').toString()
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  toggleSelectAll.addEventListener('change', () => {
    const boxes = riskList.querySelectorAll('.keep-checkbox:not(:disabled)');
    boxes.forEach(b => { b.checked = toggleSelectAll.checked; });
    updateOverrideCount();
  });

  riskList.addEventListener('change', (ev) => {
    if (ev.target && ev.target.classList.contains('keep-checkbox')) {
      updateOverrideCount();
    }
  });

  // Inject overrides on submit (both create and unlock can reuse this)
  formEl.addEventListener('submit', () => {
    Array.from(formEl.querySelectorAll('input[name="keep_entitlements[]"]')).forEach(n => n.remove());

    const checks = riskList.querySelectorAll('.keep-checkbox:checked');
    checks.forEach(chk => {
      const hid = document.createElement('input');
      hid.type = 'hidden';
      hid.name = 'keep_entitlements[]';
      hid.value = chk.getAttribute('data-user-id');
      formEl.appendChild(hid);
    });
  });

  // When modal opens, read all configuration from the clicked link
  modalEl.addEventListener('show.bs.modal', (ev) => {
    const btn = ev.relatedTarget;
    const mode = btn?.dataset?.mode || 'create';
    const year = btn?.dataset?.year;
    const month = btn?.dataset?.month;
    const title = btn?.dataset?.title || 'Confirmar';
    const submitLabel = btn?.dataset?.submitLabel || 'Confirmar';
    const actionUrl = btn?.dataset?.actionUrl || formEl.getAttribute('action') || '';
    currentImpactUrl = btn?.dataset?.impactUrl || currentImpactUrl;

    titleEl.textContent = title;
    submitBtn.textContent = submitLabel;
    formEl.action = actionUrl;
    modeInput.value = mode;
    yearInput.value = year;
    monthInput.value = month;

    setStateLoading();

    const url = new URL(currentImpactUrl, window.location.origin);
    url.searchParams.set('year', year);
    url.searchParams.set('month', month);
    url.searchParams.set('mode', mode); // if backend wants to distinguish

    fetch(url.toString(), {
      headers: { 'Accept': 'application/json' },
      credentials: 'same-origin',
    })
      .then(r => r.ok ? r.json() : Promise.reject(r))
      .then(setStateSuccess)
      .catch(async (errResp) => {
        let msg = 'Falha ao carregar o impacto.';
        if (errResp && errResp.json) {
          try {
            const j = await errResp.json();
            if (j && (j.detail || j.error)) msg = j.detail || j.error;
          } catch (_) {}
        }
        setStateError(msg);
      });
  });

  modalEl.addEventListener('hidden.bs.modal', () => setStateLoading());
})();
</script>
